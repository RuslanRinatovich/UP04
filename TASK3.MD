Предыдущее занятие |         &nbsp;          | Следующее занятие
:----------------:|:-----------------------:|:----------------:
[Задание 2](TASK2.MD) | [Содержание](README.MD) | [Задание 4](TASK4.MD)


# PostgreSQL Создание хранимых функций 

Summary: в этом уроке мы изучим как использовать конструкцию `CREATE FUNCTION` для добавления пользовательских функций(user-defined functions).


## Введение в оператор создания функции

Оператор создания функции(`CREATE FUNCTION`) позволяет определить новую пользовательскую функцию.

Вот синтаксис оператора создания функции:

```sql
CREATE [OR REPLACE] FUNCTION function_name(param_list)
   RETURNS return_type
   LANGUAGE plpgsql
  AS
$$
DECLARE
   -- variable declaration
BEGIN
   -- logic
END;
$$;
```

Разберем синтаксис:

* После ключевых слов `CREATE [OR REPLACE] FUNCTION` указывается имя функции `function_name`. Чтобы заменить существующую функцию, используйте опцию `[OR REPLACE]`.
* Затем после имени функции перечисляются параметры(можно указать тип параметров), заключенные в круглые скобки. Функция может вообще не иметь параметров.
* Затем после ключевого слова `RETURN` определяется тип данных возвращаемого значения.
* После этого используется конструкция `LANGUAGE plpgsql`, чтобы указать процедурный язык функции. Обратите внимание, что `PostgreSQL` поддерживает множество языков, включая `plpgsql`.
* [Тело функции](https://neon.tech/postgresql/postgresql-plpgsql/dollar-quoted-string-constants) помещается в строковую константу, заключенную в долларовые кавычки `$$`.

## PostgreSQL Пример создания фукнции

Возьмем таблицу room_categories из нашей БД.

![img_1.png](img_1.png)

Посчитаем сколько у нас категории комнат, стоимость которых в пределах переданных значений.

```sql

CREATE FUNCTION get_room_categories_count(price_from float4, price_to float4)
RETURNS int
LANGUAGE plpgsql
AS
$$
DECLARE
   room_categories_count integer;
BEGIN
   SELECT  count(*)
   INTO room_categories_count
   FROM room_categories
   WHERE price BETWEEN price_from AND price_to;
   RETURN room_categories_count;
END;
$$;
```

Функция `get_room_categories_count` имеет два основных раздела:

* header(заголовок);
* body(тело).

В заголовке функции указаны:

* имя функции — `get_room_categories_count`, которое следует за ключевыми словами `CREATE FUNCTION`.
* функция `get_room_categories_count` принимает два параметра `price_from` и `price_to` вещественного типа.
* функция `get_room_categories_count` возвращает целое число, указанное в предложении `RETURNS int`.
* Наконец, языком функции является `plpgsql`, обозначенный `LANGUAGE plpgsql`.

В теле функции:

* Используйте синтаксис строковой константы в долларовых кавычках, который начинается с $$ и заканчивается на $$. 
Между этими $$ можно разместить блок, содержащий объявление и логику функции.
* В разделе объявлений объявите переменную `room_categories_count`, в которой будет храниться количество категорий
из таблицы `room_categories`.
* В теле блока используйте оператор `SELECT INTO`, чтобы выбрать количество категорий, 
стоимость которых находится между `price_from` и `price_to`, и присвоить его переменной `room_categories_count`.
В конце блока используйте оператор `RETURN`, чтобы вернуть количество категорий.

Чтобы выполнить оператор создания функции, вы можете использовать любой клиентский инструмент PostgreSQL, 
включая psql, pgAdmin или DBeaver.

## Создание функции используя DBeaver

1. Запустите DBeaver и подключитесь к своей БД.
2. Нажмите правой кнопкой по названию вашей БД.
3. В контекстном меню выберите **Редактор SQL\Новый редактор SQL**.
4. Скопируйте код функции и вставьте его в окно нового редактора SQL
![img_3.png](img_3.png)
5. Выполните запрос 



[Учетные данные 215 Группа](docs/215.md)

1. Изучите макет БД, представленный на рисунке.

![hotel - public.png](hotel%20-%20public.png)

2. Доработайте структуру своей БД.

3. Заполните созданные таблицы начальными тестовыми данными (не менее трех записей в каждую таблицу). 

4. Создайте словарь данных([шаблон словаря данных](docs/DataDictionary_Template.xlsx)) БД.

5. Отправьте результаты своей работы в репозиторий на gogs-сервер(назовите репозиторий **UP04_TASK2**).

---

## Что надо загрузить в свой репозиторий?

* Скрипт БД, включающий генерацию структуры и исходные данные для импорта.
* Схему БД в виде картинки-png
* Словарь данных в формате xlsx(Excel).

## Критерии оценивания

* На оценку 5(отлично) - Создана БД. Таблицы заполнены начальными тестовыми данными. Создан словарь данных.
* На оценку 4(хорошо) - Создана БД. Создан словарь данных.
* На оценку 3(удовл) - Создана БД.



